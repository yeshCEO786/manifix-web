<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>magic16 – Yoga & Meditation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .app {
      width: 360px;
      background: #020617;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .image {
      width: 100%;
      height: 200px;
      background: #020617;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    h1 {
      font-size: 18px;
      margin: 12px 0 4px;
      text-align: center;
    }

    p {
      font-size: 14px;
      opacity: 0.85;
      text-align: center;
    }

    .timer {
      font-size: 32px;
      text-align: center;
      margin: 12px 0;
      font-weight: bold;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    button {
      flex: 1;
      margin: 4px;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      background: #1e293b;
      color: #e5e7eb;
      cursor: pointer;
    }

    button:hover {
      background: #334155;
    }
  </style>
</head>

<body>
<div class="app">

  <div class="image">
    <img id="stepImg" src="" alt="step">
  </div>

  <h1 id="stepTitle">Ready</h1>
  <p id="stepDesc">Press Play to begin</p>

  <div class="timer" id="timer">00:00</div>

  <div class="controls">
    <button onclick="prevStep()">◀</button>
    <button onclick="togglePlay()">▶ / ⏸</button>
    <button onclick="nextStep()">▶</button>
  </div>

</div>

<script>
/* =========================
   magic16 CORE ENGINE
   ========================= */

// ---------- Voice ----------
const voice = window.speechSynthesis;

function speak(text) {
  if (!voice) return;
  voice.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.9;
  u.pitch = 1;
  voice.speak(u);
}
/* =========================
   MOMENT DETECTION – CAMERA
   ========================= */

const cam = document.createElement('video');
cam.setAttribute('autoplay', true);
cam.setAttribute('playsinline', true);
cam.muted = true;
cam.style.display = 'none';
document.body.appendChild(cam);

let motionData = [];
let lastFrame = null;

async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user' }
    });
    cam.srcObject = stream;
  }catch(e){
    console.log('Camera denied');
  }
}
startCamera();
const motionCanvas = document.createElement('canvas');
const motionCtx = motionCanvas.getContext('2d');

function captureMotion(){
  if(cam.videoWidth === 0) return;

  motionCanvas.width = cam.videoWidth;
  motionCanvas.height = cam.videoHeight;
  motionCtx.drawImage(cam,0,0);

  const frame = motionCtx.getImageData(
    0,0,motionCanvas.width,motionCanvas.height
  ).data;

  if(lastFrame){
    let diff = 0;
    for(let i=0;i<frame.length;i+=20){
      diff += Math.abs(frame[i] - lastFrame[i]);
    }
    motionData.push(diff);
    if(motionData.length > 1000) motionData.shift();
  }
  lastFrame = frame;
}

// ---------- Steps ----------
function buildSteps() {
  const yoga = [
    { t:'Centering Breath', d:60, desc:'Slow deep breaths.', img:'assets/steps/yoga-01.png' },
    { t:'Neck Rolls', d:40, desc:'Gentle circles.', img:'assets/steps/yoga-02.png' },
    { t:'Sun Salutation', d:180, desc:'Flow slowly.', img:'assets/steps/yoga-03.png' },
    { t:'Warrior II', d:120, desc:'Hold and breathe.', img:'assets/steps/yoga-04.png' },
    { t:'Forward Fold', d:40, desc:'Release tension.', img:'assets/steps/yoga-05.png' },
    { t:'Tree Pose', d:60, desc:'Balance and focus.', img:'assets/steps/yoga-06.png' },
    { t:'Seated Twist', d:60, desc:'Gentle twist.', img:'assets/steps/yoga-07.png' },
    { t:'Savasana Prep', d:60, desc:'Lie down and relax.', img:'assets/steps/yoga-08.png' }
  ];

  const med = [
    { t:'Get Comfortable', d:60, desc:'Settle in.', img:'assets/steps/med-01.png' },
    { t:'Body Scan', d:120, desc:'Head to toe awareness.', img:'assets/steps/med-02.png' },
    { t:'Breath Awareness', d:180, desc:'Stay with breath.', img:'assets/steps/med-03.png' },
    { t:'Guided Imagery', d:120, desc:'Visualize calm.', img:'assets/steps/med-04.png' },
    { t:'Mantra', d:60, desc:'Repeat gently.', img:'assets/steps/med-05.png' },
    { t:'Open Awareness', d:120, desc:'Rest in awareness.', img:'assets/steps/med-06.png' },
    { t:'Return', d:120, desc:'Open eyes slowly.', img:'assets/steps/med-07.png' }
  ];

  return [...yoga, ...med];
}

const steps = buildSteps();

// ---------- State ----------
let index = 0;
let remaining = steps[0].d;
let playing = false;
let timerId = null;

// ---------- UI ----------
const imgEl = document.getElementById('stepImg');
const titleEl = document.getElementById('stepTitle');
const descEl = document.getElementById('stepDesc');
const timerEl = document.getElementById('timer');

function format(sec) {
  const m = Math.floor(sec / 60).toString().padStart(2,'0');
  const s = (sec % 60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

function render() {
  const s = steps[index];
  imgEl.src = s.img;
  titleEl.textContent = s.t;
  descEl.textContent = s.desc;
  timerEl.textContent = format(remaining);
}

// ---------- Engine ----------
function startTimer() {
  if (timerId) return;
  timerId = setInterval(() => {
    if (remaining > 0) {
      remaining--;
      timerEl.textContent = format(remaining);
    } else {
      nextStep();
    }
    captureMotion();
  }, 1000);
}

function stopTimer() {
  clearInterval(timerId);
  timerId = null;
}

function togglePlay() {
  playing = !playing;
  if (playing) {
    speak(`${steps[index].t}. ${steps[index].desc}`);
    startTimer();
  } else {
    stopTimer();
  }
}

function nextStep() {
  stopTimer();
  index = Math.min(index + 1, steps.length - 1);
  remaining = steps[index].d;
  render();
  if (playing) togglePlay();
}

function prevStep() {
  stopTimer();
  index = Math.max(index - 1, 0);
  remaining = steps[index].d;
  render();
  if (playing) togglePlay();
}

// ---------- Init ----------
render();
</script>
</body>
</html>
